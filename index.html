<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI MatchLab ULTRA</title>

  <!-- STYLES -->
  <link rel="stylesheet" href="/assets/css/theme.css" />
  <link rel="stylesheet" href="/assets/css/style.css" />
  <link rel="stylesheet" href="/assets/css/accordion.css" />
</head>
<body>
  <!-- UPDATE BANNER -->
  <div id="update-banner" class="update-banner hidden">
    <span>New version available.</span>
    <button id="btn-update-now">Update</button>
  </div>

  <!-- TOP BAR -->
  <header class="app-topbar">
    <div class="topbar-left">
      <button id="btn-back" class="icon-button tooltip" aria-label="Back" data-tooltip="Back">
        â†
      </button>
      <button id="btn-home" class="icon-button tooltip" aria-label="Home" data-tooltip="Home">
        âŒ‚
      </button>

      <div class="app-brand">
        <div class="app-pill">AIML</div>
        <div class="app-title-block">
          <div class="app-title">AI MATCHLAB ULTRA</div>
          <div class="app-subtitle">v2.1 Â· Global Live Lab</div>
        </div>
      </div>
    </div>

    <div class="app-actions">
      <button
        id="btn-language"
        class="icon-button tooltip"
        aria-label="Language"
        data-tooltip="Language"
      >
        ğŸŒ
      </button>

      <button
        id="btn-refresh-live"
        class="icon-button tooltip"
        aria-label="Refresh live"
        data-tooltip="Refresh live matches"
      >
        ğŸ”„
      </button>

      <button
        id="btn-legal"
        class="icon-button tooltip"
        aria-label="Legal"
        data-tooltip="Legal & policies"
      >
        âš–
      </button>

      <!-- INSTALL Î Î™ÎŸ Î”Î•ÎÎ™Î‘ -->
      <button
        id="btn-install"
        class="icon-button tooltip"
        aria-label="Install app"
        data-tooltip="Install AI MatchLab ULTRA"
      >
        â¬‡
      </button>

      <button
        id="theme-toggle"
        class="icon-button tooltip"
        aria-label="Toggle theme"
        data-tooltip="Toggle dark / light"
      >
        â˜¾
      </button>
    </div>
  </header>

  <!-- 30 / 40 / 30 LAYOUT -->
  <div class="app-layout">
    <!-- LEFT PANEL -->
    <aside id="left-panel" class="panel-shell">
      <h2>Navigation</h2>
      <div class="nav-accordion">
        <div class="accordion-item">
          <div class="accordion-header" data-target="panel-continents">Continents</div>
          <div class="accordion-body" id="panel-continents"></div>
        </div>

        <div class="accordion-item">
          <div class="accordion-header" data-target="panel-countries">Countries</div>
          <div class="accordion-body" id="panel-countries"></div>
        </div>

        <div class="accordion-item">
          <div class="accordion-header" data-target="panel-leagues">Leagues</div>
          <div class="accordion-body" id="panel-leagues"></div>
        </div>

        <div class="accordion-item">
          <div class="accordion-header" data-target="panel-teams">Teams</div>
          <div class="accordion-body" id="panel-teams"></div>
        </div>

        <div class="accordion-item">
          <div class="accordion-header" data-target="panel-matches">Matches</div>
          <div class="accordion-body" id="panel-matches"></div>
        </div>

        <div class="accordion-item">
          <div class="accordion-header" data-target="panel-details">Details</div>
          <div class="accordion-body" id="panel-details"></div>
        </div>
      </div>
    </aside>

    <!-- CENTER PANEL -->
    <main id="center-panel" class="panel-shell">
      <h2>Match Center</h2>
      <div id="match-details" class="glass-card">
        <div class="placeholder">Select a match to view details.</div>
      </div>
    </main>

    <!-- RIGHT PANEL -->
    <aside id="right-panel" class="panel-shell">
      <h2>Live Matches</h2>
      <div id="live-matches-list"></div>
    </aside>
  </div>

  <!-- FOOTER LEGALS -->
  <footer class="app-footer" id="app-footer">
    <div class="footer-links">
      <a href="/cookies.html" target="_blank">Cookies</a>
      <span>Â·</span>
      <a href="/privacy.html" target="_blank">Privacy</a>
      <span>Â·</span>
      <a href="/terms.html" target="_blank">Terms</a>
      <span>Â·</span>
      <a href="/disclaimer.html" target="_blank">Disclaimer</a>
      <span>Â·</span>
      <a href="/impressum.html" target="_blank">Impressum</a>
    </div>
    <div class="footer-copy">
      Â© 2025 AI MATCHLAB ULTRA â€” All rights reserved.
    </div>
  </footer>

  <!-- BOTTOM NAV FOR MOBILE -->
  <nav class="bottom-nav">
    <button data-target="home" class="bottom-nav-btn">âŒ‚</button>
    <button data-target="nav" class="bottom-nav-btn">ğŸ“‹</button>
    <button data-target="live" class="bottom-nav-btn">âš¡</button>
    <button data-target="legal" class="bottom-nav-btn">âš–</button>
    <button data-target="theme" class="bottom-nav-btn">â˜¾</button>
  </nav>

  <!-- SCRIPTS -->
  <script src="/assets/js/ui/accordion.js"></script>

  <script type="module">
    import { initApp } from "/assets/js/ui/app.js";
    import { initTheme, toggleTheme } from "/assets/js/theme.js";
    import { initLiveEngine, manualRefreshLive } from "/assets/js/live/live-engine.js";
    import { initLanguage, toggleLanguage } from "/assets/js/language.js";

    const CURRENT_VERSION = "2.1.0";

    let deferredPrompt = null;
    let installStatus = localStorage.getItem("AIML_INSTALL_STATUS") || "idle";

    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredPrompt = e;
    });

    function setInstallButtonState(btn, status) {
      installStatus = status;
      localStorage.setItem("AIML_INSTALL_STATUS", status);

      if (!btn) return;

      if (status === "installed") {
        btn.textContent = "âœ“";
        btn.dataset.tooltip = "App installed";
      } else if (status === "installing") {
        btn.textContent = "â€¦";
        btn.dataset.tooltip = "Installingâ€¦";
      } else {
        btn.textContent = "â¬‡";
        btn.dataset.tooltip = "Install AI MatchLab ULTRA";
      }
    }

    function setupTopbar() {
      const btnBack = document.getElementById("btn-back");
      const btnHome = document.getElementById("btn-home");
      const btnLang = document.getElementById("btn-language");
      const btnInstall = document.getElementById("btn-install");
      const btnRefresh = document.getElementById("btn-refresh-live");
      const btnLegal = document.getElementById("btn-legal");
      const btnTheme = document.getElementById("theme-toggle");

      // Î±ÏÏ‡Î¹ÎºÏŒ state Î³Î¹Î± install
      setInstallButtonState(btnInstall, installStatus);

      if (btnBack) {
        btnBack.addEventListener("click", () => {
          if (window.history.length > 1) {
            window.history.back();
          } else {
            window.scrollTo({ top: 0, behavior: "smooth" });
          }
        });
      }

      if (btnHome) {
        btnHome.addEventListener("click", () => {
          window.scrollTo({ top: 0, behavior: "smooth" });
          location.reload();
        });
      }

      if (btnLang) {
        btnLang.addEventListener("click", () => {
          toggleLanguage && toggleLanguage();
        });
      }

      if (btnInstall) {
        btnInstall.addEventListener("click", async () => {
          if (deferredPrompt) {
            try {
              setInstallButtonState(btnInstall, "installing");
              deferredPrompt.prompt();
              const choice = await deferredPrompt.userChoice;
              if (choice.outcome === "accepted") {
                setInstallButtonState(btnInstall, "installed");
              } else {
                setInstallButtonState(btnInstall, "idle");
              }
            } catch (e) {
              setInstallButtonState(btnInstall, "idle");
            }
            deferredPrompt = null;
          } else {
            alert('To install the app, use your browser menu and choose "Add to Home Screen".');
          }
        });
      }

      if (btnRefresh) {
        btnRefresh.addEventListener("click", () => {
          manualRefreshLive && manualRefreshLive();
        });
      }

      if (btnLegal) {
        btnLegal.addEventListener("click", () => {
          const footer = document.getElementById("app-footer");
          if (footer) {
            footer.scrollIntoView({ behavior: "smooth" });
          }
        });
      }

      if (btnTheme) {
        const syncIcon = () => {
          btnTheme.textContent =
            document.documentElement.className === "dark" ? "â˜¾" : "â˜€";
        };
        syncIcon();
        btnTheme.addEventListener("click", () => {
          toggleTheme();
          syncIcon();
        });
      }
    }

    function setupBottomNav() {
      const buttons = document.querySelectorAll(".bottom-nav-btn");
      buttons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const target = btn.getAttribute("data-target");
          if (target === "home") {
            window.scrollTo({ top: 0, behavior: "smooth" });
          } else if (target === "nav") {
            const el = document.getElementById("left-panel");
            if (el) el.scrollIntoView({ behavior: "smooth" });
          } else if (target === "live") {
            const el = document.getElementById("right-panel");
            if (el) el.scrollIntoView({ behavior: "smooth" });
          } else if (target === "legal") {
            const el = document.getElementById("app-footer");
            if (el) el.scrollIntoView({ behavior: "smooth" });
          } else if (target === "theme") {
            toggleTheme();
          }
        });
      });
    }

    async function checkVersion() {
      try {
        const res = await fetch("/version.json", { cache: "no-store" });
        if (!res.ok) return;
        const data = await res.json();
        if (data.version && data.version !== CURRENT_VERSION) {
          const banner = document.getElementById("update-banner");
          const btnUpdate = document.getElementById("btn-update-now");
          if (banner) banner.classList.remove("hidden");
          if (btnUpdate) {
            btnUpdate.addEventListener("click", () => {
              location.reload();
            });
          }
        }
      } catch (e) {
        // ignore
      }
    }

    function main() {
      initTheme();
      initLanguage && initLanguage();
      initApp();
      initLiveEngine();
      setupTopbar();
      setupBottomNav();
      checkVersion();
      setInterval(checkVersion, 5 * 60 * 1000);
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", main);
    } else {
      main();
    }
  </script>
</body>
</html>
